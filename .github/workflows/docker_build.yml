name: Build & push docker image and deploy to environment

on:
  workflow_call:
    inputs:
      docker_registry:
        description: Docker registry
        required: true
        type: string
      registry_org:
        description: Docker registry organisation
        required: true
        type: string
      additional_docker_tag:
        description: Additional docker tag that can be used to specify stable tags
        required: false
        type: string
      push:
        description: Push docker image to registry flag
        required: true
        type: boolean
      docker_multiplatform:
        description: Docker image build multiplatform or not
        required: true
        type: boolean

    secrets:
      HMPPS_QUAYIO_USER:
        required: false
      HMPPS_QUAYIO_TOKEN:
        required: false

    outputs:
      app_version:
        description: The version of the app as generated by create_app_version
        value: ${{ jobs.docker_build.outputs.version }}

permissions:
  contents: read
  packages: write

jobs:
  docker_build:
    name: Build docker image
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.app_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: app_version
        name: Application version creators
        uses: ./.github/actions/create_app_version # WORKFLOW_VERSION
      - uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          platforms: linux/amd64,linux/arm64
          cache-to: type=gha,mode=max
          context: .
          push: ${{ inputs.push }}
          secret-envs: |
            "sentry=SENTRY_AUTH_TOKEN"
          provenance: false
          build-args: |
            "BUILD_NUMBER=${{ steps.app_version.outputs.version }}
            "GIT_REF=${{ github.sha }}"
            "GIT_BRANCH=${{ github.ref_name }}"
          tags: |
            ${{ inputs.docker_registry}}/${{ inputs.registry_org }}/${{ github.event.repository.name }}:latest
            ${{ inputs.docker_registry}}/${{ inputs.registry_org }}/${{ github.event.repository.name }}:${{ steps.app_version.outputs.version }}
#      - uses: ./.github/actions/build_multiplatform_docker # WORKFLOW_VERSION
#        if: ${{ ( inputs.docker_registry  == 'ghcr.io' ) && ( inputs.docker_multiplatform )}}
#        with:
#          repository_name: ${{ github.event.repository.name }}
#          docker_registry: ${{ inputs.docker_registry }}
#          registry_org: ${{ inputs.registry_org }}
#          additional_docker_tag: ${{ inputs.additional_docker_tag }}
#          push: ${{ inputs.push }}
#          app_version: ${{ steps.app_version.outputs.version }}


