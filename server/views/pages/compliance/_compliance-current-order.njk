{% for compliance in personCompliance.currentSentences %}
    {% set failureToComplyCount = compliance.failureToComplyCount %}
    {% set unacceptableAbsenceCount = compliance.unacceptableAbsenceCount %}
    {% set attendedButDidNotComplyCount = compliance.attendedButDidNotComplyCount  %}
    {% set outcomeNotRecordedCount = compliance.outcomeNotRecordedCount %}
    {% set waitingForEvidenceCount = compliance.waitingForEvidenceCount  %}
    {% set rescheduledCount = compliance.rescheduledCount %}
    {% set absentCount = compliance.absentCount %}
    {% set rescheduledByStaffCount = compliance.rescheduledByStaffCount %}
    {% set rescheduledByPersonOnProbationCount = compliance.rescheduledByPersonOnProbationCount %}
    {% set lettersCount = compliance.lettersCount %}
    {% set nationalStandardAppointmentsCount = compliance.nationalStandardAppointmentsCount %}
    {% set compliedAppointmentsCount = compliance.compliedAppointmentsCount %}

    {% set complianceStatus = getComplianceStatus(failureToComplyCount, compliance.breachStarted) %}

    {% if compliance.rar %}
        {% set requirements %}
            {{ compliance.rar.totalDays }} days RAR, {{ compliance.rar.completed }} completed
        {% endset %}
    {% else %}
        {% set requirements = false %}
    {% endif %}


    {% if not compliance.activeBreach and not compliance.rar %}
        {% set lastSentence = "--last"  %}
    {% else %}
        {% set lastSentence = ""  %}
    {% endif %}

    {% if compliance.activeBreach and not compliance.rar %}
        {% set lastBreach = "--last"  %}
    {% else %}
        {% set lastBreach = ""  %}
    {% endif %}

    <div class="app-compliance-panel {{ complianceStatus.panelClass }}">
      <p class="govuk-!-margin-bottom-0 govuk-!-font-weight-bold">
      {% if failureToComplyCount >= 2 %}
        {{ complianceStatus.text }} â€“ <a href = "/case/{{ crn }}/handoff/delius">Start a breach</a>
      {% else %}
        {{ complianceStatus.text }}
      {% endif %}
      </p>
    </div>

    {% set breachesOnCurrentOrder %}
      <ul class="govuk-list">
        {% if compliance.breachStarted %}<li>A breach is in progress</li>{% endif %}
        <li>{% include './_breaches-on-current-order.njk' %}</li>
      </ul>
    {% endset %}

    {% set orderDetailsList %}
      {{ govukSummaryList({
        rows: [
          {
            key: {
              text: 'Main offence'
            },
            value: {
              html: compliance.mainOffence.description
            }
          },
          {
            key: {
              text: 'Order'
            },
            value: {
              html: compliance.order.description + ' (' +  compliance.order.startDate | monthsOrDaysElapsed + ' elapsed)'
            }
          },
          {
            key: {
              text: 'Start date'
            },
            value: {
              html: compliance.order.startDate | dateWithYear
            }
          },
          {
            key: {
              text: 'Breaches'
            },
            value: {
              html: breachesOnCurrentOrder
            }
          }
        ]
      }) }}
    {% endset %}

    {{ appSummaryCard({
      classes: 'app-summary-card--compliance' + lastSentence + ' app-summary-card--large-title',
      titleText: "Sentence",
      html: orderDetailsList,
      actions: {
        items: [
          {
            text: 'View sentence details',
            href: '/case/'+ crn + '/sentence'
          }
        ]
      }
    }) }}

    {% if compliance.activeBreach %}
      {% set breachList %}
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: 'Breach started'
              },
              value: {
                html: compliance.activeBreach.startDate
              }
            },
            {
              key: {
                text: 'Status'
              },
              value: {
                html: compliance.activeBreach.status
              }
            }
          ]
        }) }}
      {% endset %}

      {{ appSummaryCard({
        classes: 'app-summary-card--compliance' + lastBreach + ' app-summary-card--large-title',
        titleText: "Breach details",
        html: breachList,
        actions: {
          items: [
            {
              href: "",
              text: "View in Delius",
              visuallyHiddenText: "name"
            }
          ]
        }
      }) }}
    {% endif %}

    {% set failureToComplyHtml %}
      {% if failureToComplyCount == 0 %}
        None
      {% elseif attendedButDidNotComplyCount == 0 %}
        <a href="/case/{{ crn }}/activity-log/all-failure-to-comply-appointments">
          {% if unacceptableAbsenceCount == 1 %}1 unacceptable absence{% else %}{{ unacceptableAbsenceCount }} unacceptable absences{% endif %}
        </a>
      {% elseif unacceptableAbsenceCount == 0 %}
        <a href="/case/{{ crn }}/activity-log/all-failure-to-comply-appointments">
          {% if attendedButDidNotComplyCount == 1 %}1 failure{% else %}{{ attendedButDidNotComplyCount }} failures{% endif %} to comply because of behaviour
        </a>
      {% else %}
        <p><a href="/case/{{ crn }}/activity-log/all-failure-to-comply-appointments">{{ failureToComplyCount }} failures to comply</a>:</p>
        <ul class="govuk-list govuk-!-margin-top-2">
          <li>{{ unacceptableAbsenceCount }} unacceptable absence</li>
          <li>{{ attendedButDidNotComplyCount }} failure to comply because of behaviour</li>
        </ul>
      {% endif %}
    {% endset %}

    {% set acceptableAbsencesHtml %}

      {% if absentCount > 0 %}
        <a href="/case/{{ crn }}/activity-log/acceptable-absence-appointments">{{ absentCount }} acceptable absences</a>
      {% else %}
        None
      {% endif %}
    {% endset %}

    {% set waitingForEvidenceHtml %}
      {% if waitingForEvidenceCount > 0 %}
        <a href="/case/{{ crn }}/activity-log/waiting-for-evidence">{{ waitingForEvidenceCount }} absence waiting for evidence</a>
      {% elseif waitingForEvidenceCount > 0 %}
        <a href="/case/{{ crn }}/activity-log/waiting-for-evidence">{{ waitingForEvidenceCount }} absences waiting for evidence</a>
      {% else %}
        None
      {% endif %}
    {% endset %}

    {% set rescheduledHtml %}


      {% if rescheduledCount == 0 %}
        None
      {% elseif rescheduledByStaffCount == 0 %}
        <a href="/case/{{ crn }}/activity-log/all-rescheduled">
          {{ rescheduledByPersonOnProbationCount }} requested by {{ personCompliance.personSummary.name | fullName }}
        </a>
      {% elseif rescheduledByPersonOnProbationCount == 0 %}
        <a href="/case/{{ crn }}/activity-log/all-rescheduled">
          {{ rescheduledByStaffCount }} requested by staff
        </a>
      {% else %}
        <p><a href="/case/{{ crn }}/activity-log/all-rescheduled">{{ rescheduledCount }} rescheduled</a>:</p>
        <ul class="govuk-list govuk-!-margin-top-2">
          <li>{{ rescheduledByPersonOnProbationCount }} requested by {{ personCompliance.personSummary.name | fullName }}</li>
          <li>{{ rescheduledByStaffCount }} requested  by staff</li>
        </ul>
      {% endif %}
    {% endset %}

    {% set warningLettersHtml %}

      {% if lettersCount === 1 %}
        <a href="/case/{{ crn }}/activity-log/warning-letters">First warning letter sent</a>
      {% elif lettersCount > 1 %}
        <a href="/case/{{ crn }}/activity-log/warning-letters">{{ lettersCount }} letters sent</a>
      {% else %}
        None
      {% endif %}
    {% endset %}

    {% if requirements %}
        {% set rarList %}
          {{ govukSummaryList({
            rows: [
              {
                key: {
                  text: 'Appointments'
                },
                value: {
                  html: '<a href="/case/' + crn + '/activity-log/national-standard-appointments">' + nationalStandardAppointmentsCount + ' national standard appointments</a>'
                }
              },
              {
                key: {
                  text: 'Without an outcome'
                },
                value: {
                  html: '<a href="/case/' + crn + '/activity-log/national-standard-appointments-without-outcome">' + outcomeNotRecordedCount + ' without a recorded outcome</a>'
                }
              } if outcomeNotRecordedCount > 0,
              {
                key: {
                  text: 'Waiting for evidence'
                },
                value: {
                  html: waitingForEvidenceHtml
                }
              } if waitingForEvidenceCount > 0,
              {
                key: {
                  text: 'Complied'
                },
                value: {
                  html: '<a href="/case/' + crn + '/activity-log/complied-appointments">' + compliedAppointmentsCount + ' complied</a>'
                }
              },
              {
                key: {
                  html: 'Failures to comply<br>within 12 months'
                },
                value: {
                  html: failureToComplyHtml
                }
              },
              {
                key: {
                  html: 'Warning letters sent within 12 months'
                },
                value: {
                  html: warningLettersHtml
                }
              } if data.features.showWarningLetters,
              {
                key: {
                  text: 'Acceptable absences'
                },
                value: {
                  html: acceptableAbsencesHtml
                }
              },
              {
                key: {
                  text: 'Rescheduled'
                },
                value: {
                  html: rescheduledHtml
                }
              }
            ]
          }) }}
        {% endset %}

        {{ appSummaryCard({
          classes: "govuk-!-margin-bottom-6 app-summary-card--compliance-last app-summary-card--large-title",
          titleHtml: '<span class="govuk-!-font-size-19 govuk-!-font-weight-regular">Requirement</span><br />' + requirements,
          html: rarList
        }) }}
    {% endif %}
{% endfor %}
